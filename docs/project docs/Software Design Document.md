# 软件设计文档

## 总体设计
此项目将基于YOLO目标检测算法，以监控画面作为输入，来实时匹配校园中正在骑行的自行车与自行车上的人，并建立一个数据库来存储各自行车与人的特征向量的配对。当发现全新的配对时，会将此配对及对应画面加入预警库，从而对自行车盗窃进行预警，并为找回被盗自行车提供便利。我们的预期使用场景是：当有学生自行车被盗时，可以通过查询预警库来大幅减少查看监控的代价，大幅提高寻找被盗自行车的效率。



## 项目框架
项目分为识别管线与数据库交互两部分。
### 识别管线
- 输入端为学校内各监控的画面
- 使用YOLOv8目标检测算法，分割出画面中的自行车与人。我们只取置信度高的自行车与人，以减少误识别。我们使用滤波算法来提高识别稳定性。这一步得到分割出的人车图像与对应的位置信息。
- 将人车图像分别送入表示学习模型，得到人脸与自行车的特征向量。
- 使用空间上的相邻关系与速度上的关联来匹配自行车与人（算法待定）。此处同样使用滤波算法来提高匹配稳定性。这一步将得到人脸与自行车的配对，将其中结果较稳定者（再用一次滤波）送入数据库

### 数据库交互
我们使用一个数据库来存储各自行车与人的特征向量的配对。
同时我们也建立一个预警库来存储可疑的人车配对及其画面样本。当发现全新的配对时，会将此配对及对应画面加入预警库以便对自行车盗窃进行预警，存储的画面将用于为找回被盗自行车提供便利。


- 数据库运行初期需要一定时间收集数据来建库。每年新生入学时也需要暂停预警功能，以便将新生数据入库。
- 考虑到新购买自行车等产生新的人车配对的情况，可以将预警库中较长时间跨度内多次出现的人车配对加入正常数据库，不进行预警。
- 数据库中许久未访问的项可视为错误识别结果或毕业学生数据，用老化机制来剔除。
- 共享单车的数据可以被过滤。

- 由于识别的结果不会是稳定的，在几乎相同的时间、地点下的同一辆车的识别结果有时会出现跳变，为提高鲁棒性，可能还需要加入基于时间与地点信息的滤波算法，使得在时间地点变化不大时，识别结果具有一致性。

  

## 模块设计
### 输入模块
输入模块负责接收学校内各监控的画面，作为识别管线的输入。

功能：

接收监控画面
对画面进行预处理（如缩放、裁剪等）
将预处理后的画面传递给下一模块



### 目标检测模块
目标检测模块使用YOLOv8目标检测算法，对输入的画面进行目标检测，分割出画面中的自行车与人。只保留置信度高的目标，以减少误识别。
我们选择YOLOX-m模型来完成目标检测功能，该模型参数量为25.33M, Gflops量为73.98

功能：

对输入画面进行目标检测
分割出自行车与人的目标
筛选出置信度高的目标
输出分割结果及位置信息



### 表示学习模块
表示学习模块负责将分割出的人车图像分别送入模型，得到人脸与自行车的特征向量。

功能：

接收分割出的人车图像
提取人脸与自行车的特征向量
输出特征向量



### 匹配模块
匹配模块使用空间上的相邻关系与速度上的关联来匹配自行车与人，得到人脸与自行车的配对。

功能：

接收人脸与自行车的特征向量
使用空间上的相邻关系与速度上的关联进行匹配
输出人脸与自行车的配对结果




### 数据库模块
利用mysql存储关系表，与milvus的collection相关联。mysql做人车id记录，时间戳与地点戳记录等等，milvus负责特征向量存储与搜索。

##### mysql存储字段：

- pair_id(主键,创建索引，与milvus中pair_id相同)
- bicycle_id(外键关联到mysql另一个表bicycle_photos)
- person_id(外键关联到mysql另一个表person_photos)
- create_date
- camera_id
- modify_date

##### milvus存储字段：

- pair_id(主键，创建索引)
- bicycle_embedding
- person_embedding




### 预警模块
预警模块负责监测新的人车配对，将全新的配对及对应画面加入预警库，以提供自行车盗窃的预警功能。

功能：

监测新的人车配对
将全新的配对及对应画面加入预警库
提供预警功能，用于对自行车盗窃进行预警



### 接口模块
接口模块负责与其他系统进行接口交互，例如与监控系统进行画面获取与控制，与校园安全系统进行联动等。

功能：

与监控系统进行画面获取与控制的接口
与校园安全系统进行联动的接口
与其他系统进行数据交换的接口







